name: Build Windows Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., v2.0.0)'
        required: true
        default: 'v0.0.0-alpha'
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: false
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-gtk3
          mingw-w64-x86_64-json-glib
          
    - name: Build
      shell: msys2 {0}
      run: |
        mkdir build && cd build
        cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release
        ninja
        
    - name: Package
      shell: msys2 {0}
      run: |
        cd build
        mkdir ottsr-windows
        cp ottsr.exe ottsr-windows/
        
        # Copy required DLLs
        ldd ottsr.exe | grep mingw64 | awk '{print $3}' | while read dll; do
          if [ -f "$dll" ]; then
            cp "$dll" ottsr-windows/
          fi
        done
        
        # Create batch file
        cat > ottsr-windows/run.bat << 'EOF'
        @echo off
        cd /d "%~dp0"
        start ottsr.exe
        EOF

    - name: Create Zip
      run: |
        Compress-Archive -Path build/ottsr-windows -DestinationPath ottsr-windows.zip -Force

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ottsr-windows
        path: ottsr-windows.zip
        
    - name: Create Release
      if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        name: Study Timer Pro ${{ github.event.inputs.version || github.ref_name }}
        body: |
          ## Study Timer Pro - Windows Release
          
          Simple GTK-based study timer for Windows.
          
          **Download**: `ottsr-windows.zip`
          
          **Installation**: Extract and run `ottsr.exe` or double-click `run.bat`
          
          Built with: GTK3, JSON-GLib, GLib
        files: ottsr-windows.zip
